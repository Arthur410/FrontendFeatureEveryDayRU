# structuredClone

Created: October 3, 2024 8:52 PM

–í—ã –∑–Ω–∞–ª–∏, —á—Ç–æ —Ç–µ–ø–µ—Ä—å –≤ JavaScript –µ—Å—Ç—å –Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–µ–ª–∞—Ç—å –≥–ª—É–±–æ–∫–∏–µ –∫–æ–ø–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤? –≠—Ç–æ —Å—Ç–∞–ª–æ –≤–æ–∑–º–æ–∂–Ω—ã–º —Å –ø–æ–º–æ—â—å—é —Ñ—É–Ω–∫—Ü–∏–∏¬†`structuredClone`, –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –≤ —Å—Ä–µ–¥—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è JavaScript:

```jsx
const calendarEvent = {
  title: "Builder.io Conf",
  date:new Date(123),
  attendees: ["Steve"]
}

// üòç
const copied = structuredClone(calendarEvent)
```

–í—ã –∑–∞–º–µ—Ç–∏–ª–∏, —á—Ç–æ –≤ —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ –º—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏ –Ω–µ —Ç–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç, –Ω–æ –∏ –≤–ª–æ–∂–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤, –∏ –¥–∞–∂–µ –æ–±—ä–µ–∫—Ç Date?

–ò –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–º–µ–Ω–Ω–æ —Ç–∞–∫, –∫–∞–∫ –º—ã –∏ –æ–∂–∏–¥–∞–ª–∏:

```jsx
copied.attendees // ["Steve"]
copied.date // Date: Wed Dec 31 1969 16:00:00
cocalendarEvent.attendees === copied.attendees // false
```

`structuredClone`¬†–º–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω–æ–µ, –Ω–æ –∏ —Ç–∞–∫–∂–µ:

- –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –∏ –º–∞—Å—Å–∏–≤—ã.
- –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏.
- –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —à–∏—Ä–æ–∫–∏–π —Å–ø–µ–∫—Ç—Ä —Ç–∏–ø–æ–≤ JavaScript, —Ç–∞–∫–∏—Ö –∫–∞–∫:¬†`Date`*,*¬†`Set`*,*¬†`Map`*,*¬†`Error`*,*¬†`RegExp`*,*¬†`ArrayBuffer`*,*¬†`Blob`*,*¬†`File`*,*¬†`ImageData`¬†–∏¬†[–º–Ω–æ–≥–∏–µ –¥—Ä—É–≥–∏–µ](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm#supported_types).
- –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ª—é–±—ã–µ¬†[–ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–µ –æ–±—ä–µ–∫—Ç—ã](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Transferable_objects).

–≠—Ç–æ –±–µ–∑—É–º–∏–µ –¥–∞–∂–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–∞–∫, –∫–∞–∫ –º—ã –∏ –æ–∂–∏–¥–∞–ª–∏:

```jsx
const kitchenSink = {
  set:new Set([1, 3, 3]),
  map:new Map([[1, 2]]),
  regex: /foo/,
  deep: { array: [new File(someBlobData, 'file.txt') ] },
  error:new Error('Hello!')
}
kitchenSink.circular = kitchenSink

// ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–Ω–æ–µ –≥–ª—É–±–æ–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
const clonedSink = structuredClone(kitchenSink)
```

### **–ü–æ—á–µ–º—É –±—ã –ø—Ä–æ—Å—Ç–æ –Ω–µ —Å–¥–µ–ª–∞—Ç—å object spread?**

–í–∞–∂–Ω—ã–º –æ—Ç–º–µ—Ç–∏—Ç—å, —á—Ç–æ –º—ã –≥–æ–≤–æ—Ä–∏–º –æ –≥–ª—É–±–æ–∫–æ–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏. –ï—Å–ª–∏ –∂–µ –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ç–æ –µ—Å—Ç—å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –≤–∫–ª—é—á–µ–Ω–∏—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–≤, —Ç–æ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å¬†spread –æ–±—ä–µ–∫—Ç–∞:

```jsx
const simpleEvent = {
  title: "Builder.io Conf",
}
// ‚úÖ –Ω–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–≤
const shallowCopy = {...calendarEvent}
```

–ò–ª–∏ –¥–∞–∂–µ –æ–¥–∏–Ω –∏–∑ —ç—Ç–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ:

```jsx
const shallowCopy = Object.assign({}, simpleEvent)
const shallowCopy = Object.create(simpleEvent)
```

–ù–æ –∫–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –º—ã —Å—Ç–∞–ª–∫–∏–≤–∞–µ–º—Å—è —Å –ø—Ä–æ–±–ª–µ–º–æ–π:

```jsx
const calendarEvent = {
  title: "Builder.io Conf",
  date:new Date(123),
  attendees: ["Steve"]
}

const shallowCopy = {...calendarEvent}

// üö© —É–ø—Å - –º—ã –¥–æ–±–∞–≤–∏–ª–∏ "Bob" –∏ –≤ –∫–æ–ø–∏—é –∏ –≤ –≤–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
shallowCopy.attendees.push("Bob")

// üö© —É–ø—Å - –º—ã –æ–±–Ω–æ–≤–∏–ª–∏ –¥–∞—Ç—É –∫–æ–ø–∏–∏ –∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
shallowCopy.date.setTime(456)
```

–ö–∞–∫ –≤–∏–¥–Ω–æ, –º—ã –Ω–µ —Å–¥–µ–ª–∞–ª–∏ –ø–æ–ª–Ω—É—é –∫–æ–ø–∏—é —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.

–í–ª–æ–∂–µ–Ω–Ω—ã–µ –¥–∞—Ç–∞ –∏ –º–∞—Å—Å–∏–≤ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É —è–≤–ª—è—é—Ç—Å—è –æ–±—â–µ–π —Å—Å—ã–ª–∫–æ–π –¥–ª—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –∏ ¬´–∫–æ–ø–∏–∏¬ª. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–µ ‚Äì –µ—Å–ª–∏ –º—ã –∑–∞—Ö–æ—Ç–∏–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö, –¥—É–º–∞—è, —á—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è.

### **–ü–æ—á–µ–º—É –Ω–µ JSON.parse(JSON.stringify(x))?**

–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —ç—Ç–æ –æ—Ç–ª–∏—á–Ω—ã–π —Ö–∞–∫ –∏ –Ω–∞ —É–¥–∏–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π, –Ω–æ —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç¬†`structuredClone`.

–í–æ–∑—å–º–µ–º –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞:

```jsx
const calendarEvent = {
  title: "Builder.io Conf",
  date:new Date(123),
  attendees: ["Steve"]
}

// üö© JSON.stringify –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–ª –¥–∞—Ç—É –≤ —Å—Ç—Ä–æ–∫—É
const problematicCopy = JSON.parse(JSON.stringify(calendarEvent))
```

–ï—Å–ª–∏ –≤—ã–≤–µ—Å—Ç–∏¬†`ProblematicCopy`, –º—ã –ø–æ–ª—É—á–∏–º:

```jsx
{
  title: "Builder.io Conf",
  date: "1970-01-01T00:00:00.123Z"
  attendees: ["Steve"]
}
```

–ú—ã —Ö–æ—Ç–µ–ª–∏ –Ω–µ —ç—Ç–æ–≥–æ.¬†`date`¬†–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ —Å—Ç—Ä–æ–∫–æ–π, –∞ –æ–±—ä–µ–∫—Ç–æ–º¬†`Date`.

–≠—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ¬†`JSON.stringify`¬†–º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –æ–±—ä–µ–∫—Ç—ã, –º–∞—Å—Å–∏–≤—ã –∏ –ø—Ä–∏–º–∏—Ç–∏–≤—ã. –õ—é–±–æ–π –¥—Ä—É–≥–æ–π —Ç–∏–ø –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º –æ–±—Ä–∞–∑–æ–º. –ù–∞–ø—Ä–∏–º–µ—Ä, Dates –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç—Å—è –≤ string. –ù–æ¬†`Set`¬†–ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤¬†`{}`.

–ß—Ç–æ-—Ç–æ¬†`JSON.stringify`¬†–¥–∞–∂–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç ‚Äì –Ω–∞–ø—Ä–∏–º–µ—Ä,¬†`undefined`¬†–∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏.

–°–∫–∞–∂–µ–º, –µ—Å–ª–∏ –º—ã —Å–∫–æ–ø–∏—Ä—É–µ–º –ø—Ä–∏–º–µ—Ä¬†`kitchenSink`¬†—Å –ø–æ–º–æ—â—å—é —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞:

```jsx
const kitchenSink = {
  set:new Set([1, 3, 3]),
  map:new Map([[1, 2]]),
  regex: /foo/,
  deep: { array: [new File(someBlobData, 'file.txt') ] },
  error:new Error('Hello!')
}

const veryProblematicCopy = JSON.parse(JSON.stringify(kitchenSink))
```

–¢–æ –º—ã –ø–æ–ª—É—á–∏–º:

```jsx
{
  "set": {},
  "map": {},
  "regex": {},
  "deep": {
    "array": [
      {}
    ]
  },
  "error": {},
}
```

–§—É!

–ò –¥–∞, –ø—Ä–∏—à–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É, –∫–æ—Ç–æ—Ä–∞—è —É –Ω–∞—Å –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –±—ã–ª–∞, –ø–æ—Å–∫–æ–ª—å–∫—É¬†`JSON.stringify`¬†–ø—Ä–æ—Å—Ç–æ –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Å –æ–¥–Ω–æ–π –∏–∑ –Ω–∏—Ö.

–ú–µ—Ç–æ–¥¬†`JSON.stringify`¬†—É–¥–æ–±–µ–Ω, –≤ —Å–ª—É—á–∞–µ –µ—Å–ª–∏ –Ω–∞—à–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –µ–≥–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º. –û–¥–Ω–∞–∫–æ —Å –ø–æ–º–æ—â—å—é¬†`StructuredClone`¬†–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –º–Ω–æ–≥–æ–µ –∏–∑ —Ç–æ–≥–æ, —á–µ–≥–æ –Ω–µ –º–æ–∂–µ—Ç¬†`JSON.stringify`.

### **–ü–æ—á–µ–º—É –Ω–µ _.cloneDeep?**

–î–æ —Å–∏—Ö –ø–æ—Ä —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–º —Ä–µ—à–µ–Ω–∏–µ–º —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã –±—ã–ª–∞ —Ñ—É–Ω–∫—Ü–∏—è¬†`cloneDeep`¬†–±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Lodash.

–û–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫, –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è:

```jsx
import cloneDeepfrom 'lodash/cloneDeep'

const calendarEvent = {
  title: "Builder.io Conf",
  date:new Date(123),
  attendees: ["Steve"]
}

// ‚úÖ –í—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ
const clonedEvent = structuredClone(calendarEvent)
```

–ù–æ —Å –æ–¥–Ω–æ–π –æ–≥–æ–≤–æ—Ä–∫–æ–π. –°–æ–≥–ª–∞—Å–Ω–æ –¥–∞–Ω–Ω—ã–º —Ä–∞–±–æ—Ç—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è¬†[Import Cost](https://marketplace.visualstudio.com/items?itemName=wix.vscode-import-cost)¬†–≤ IDE, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã–≤–æ–¥–∏—Ç –≤–µ—Å –≤ –ö–± –≤—Å–µ–≥–æ, —á—Ç–æ —è –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é, —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç 17,4 –ö–± –≤ —Å–∂–∞—Ç–æ–º –≤–∏–¥–µ (5,3 –ö–± –≤ –∞—Ä—Ö–∏–≤–µ):

![https://habrastorage.org/r/w1560/getpro/habr/upload_files/403/0f5/bf1/4030f5bf1f55dbce849c4f44a4e9d1b8.png](https://habrastorage.org/r/w1560/getpro/habr/upload_files/403/0f5/bf1/4030f5bf1f55dbce849c4f44a4e9d1b8.png)

–≠—Ç–æ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç, —á—Ç–æ –≤—ã –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç–µ —Ç–æ–ª—å–∫–æ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é. –ï—Å–ª–∏ –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º, –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—è –≤ —Ä–∞—Å—á–µ—Ç, —á—Ç–æ¬†tree shaking¬†–Ω–µ –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫, –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è, –º–æ–∂–Ω–æ —Å–ª—É—á–∞–π–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ¬†[25 –ö–±](https://bundlephobia.com/package/lodash@4.17.21)¬†—Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–π –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.

![https://habrastorage.org/r/w1560/getpro/habr/upload_files/d66/506/31c/d6650631c32fdf87698d68320062a544.jpeg](https://habrastorage.org/r/w1560/getpro/habr/upload_files/d66/506/31c/d6650631c32fdf87698d68320062a544.jpeg)

–•–æ—Ç—è —ç—Ç–æ –∏ –Ω–µ —Å—Ç–∞–Ω–µ—Ç –∫–æ–Ω—Ü–æ–º —Å–≤–µ—Ç–∞, –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ ‚Äì –Ω–µ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –±—Ä–∞—É–∑–µ—Ä—ã —É–∂–µ –∏–º–µ—é—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π¬†`structuredClone`.
